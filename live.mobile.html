<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Turnos ¬∑ M√≥vil</title>
<link rel="icon" href="img/cumbria.png">

<style>
/* ======== ESTILOS (embebidos) ======== */
:root{
  --bg:#f6f8fb; --card:#ffffff; --line:#e7ecf3; --text:#1f2937; --muted:#6b7280;
  --col-nombre-min:88px; --col-nombre:26%;
  --cell-pad:10px 12px; --pill-gap:8px; --pill-pad:6px 10px; --pill-radius:999px;
  --fz-base:14px; --fz-small:12px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
  font:400 var(--fz-base)/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial;}
.app-header{position:sticky;top:0;background:linear-gradient(#fff,#fff0);padding:12px 12px 8px;border-bottom:1px solid var(--line);z-index:5}
.hotel-box{display:flex;gap:12px;align-items:center}
.hotel-logo{width:38px;height:38px;object-fit:contain;opacity:.9}
.hotel-meta h1{font-size:20px;margin:0 0 2px}
.date-range{font-size:var(--fz-small);color:var(--muted)}
.filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.filters label{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--muted)}
.filters input[type="date"], .filters select{padding:6px 8px;border:1px solid var(--line);border-radius:10px;background:#fff}
.filters button{padding:8px 12px;border:1px solid var(--line);background:#fff;border-radius:12px;cursor:pointer}

.viewport{padding:12px}
.tabla{border:1px solid var(--line);background:var(--card);border-radius:14px;overflow:auto}

/* Cabecera y filas en grid */
.t-head, .t-row{display:grid;grid-template-columns:minmax(var(--col-nombre-min),var(--col-nombre)) repeat(7, 1fr)}
.t-head{position:sticky;top:78px;background:var(--card);z-index:4;border-bottom:1px solid var(--line)}
.t-head .cell{padding:10px 8px;font-size:12px;color:var(--muted);text-align:center;white-space:nowrap}
.t-row{border-bottom:1px solid var(--line)}
.t-row .cell{padding:var(--cell-pad)}
.t-row .cell.name{position:sticky;left:0;background:linear-gradient(90deg, #fff 60%, #fff8);border-right:1px solid var(--line);z-index:3}
.name .emp{font-weight:600}

/* Contenido de turnos */
.shifts{display:flex;flex-wrap:wrap;gap:var(--pill-gap);align-items:flex-start;min-height:36px}

/* P√≠ldoras */
.pill{display:inline-flex;align-items:center;gap:6px;padding:var(--pill-pad);border-radius:var(--pill-radius);border:1px solid transparent;line-height:1}
.pill small{font-size:12px;color:#506070}
.pill .i{opacity:.9}

/* Colores de estado */
.pill--manana{background:#e6f7ee;border-color:#c7eddc}
.pill--tarde{background:#fff6db;border-color:#fdeab3}
.pill--noche{background:#eef2f6;border-color:#d9e2ec}
.pill--descanso{background:#ffe7ea;border-color:#ffccd3}
.pill--vacaciones{background:#e6fbff;border-color:#c7f1ff}

/* Varios */
.t-empty{padding:16px;color:#6b7280}
.doc-end-rule{height:10px;border:0;background:linear-gradient(90deg,#c6a44a,#e6d28f,#c6a44a);border-radius:10px;margin:22px 0 6px}
.doc-end-space{height:28px}

/* Responsive */
@media (max-width:640px){
  :root{ --col-nombre: 28%; --col-nombre-min:84px; --pill-gap:7px }
  .hotel-meta h1{font-size:18px}
  .t-head .cell{font-size:11px}
}
</style>
</head>
<body>
  <header class="app-header">
    <div class="hotel-box">
      <img class="hotel-logo" src="img/cumbria.png" alt="Hotel" onerror="this.style.display='none'">
      <div class="hotel-meta">
        <h1 id="hotelNombre">Hotel</h1>
        <div id="rangoFechas" class="date-range">‚Äî</div>
      </div>
    </div>
    <div class="filters">
      <label>Semana (lunes): <input id="semanaInput" type="date"></label>
      <label>Hotel: <select id="hotelSelect"></select></label>
      <button id="refrescarBtn">Actualizar</button>
    </div>
  </header>

  <main class="viewport">
    <div class="tabla" id="tablaTurnos" aria-live="polite"></div>
  </main>

  <footer class="doc-foot">
    <hr class="doc-end-rule"><div class="doc-end-space"></div>
  </footer>

  <!-- Si existe, se usar√° FULL_DATA; si no, se tirar√° del CSV -->
  <script src="data.js?v=TS" defer></script>
  <script src="data.ausencias.js?v=TS" defer></script>

<script>
/* ======== APP (embebida) ======== */
(() => {
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const capitalize = (s) => s ? s.charAt(0).toUpperCase()+s.slice(1) : s;
  const fmt = (d) => new Date(d).toLocaleDateString('es-ES',{weekday:'short', day:'2-digit', month:'short', year:'2-digit'});

  let DATA = null;

  // --- Entrada de datos
  async function initData(){
    // 1) FULL_DATA de data.js
    if (window.FULL_DATA?.schedule?.length) { DATA = window.FULL_DATA; return; }

    // 2) CSV
    try {
      const [turnosCsv, ausCsv] = await Promise.all([
        fetchSafe('turnos.csv'),
        fetchSafe('ausencias.csv')
      ]);
      if (turnosCsv.trim().length){ DATA = csvToFullData(turnosCsv, ausCsv); return; }
    } catch(_) {}

    DATA = { schedule: [] };
  }

  async function fetchSafe(url){
    try{
      const r = await fetch(url);
      if (!r.ok) return '';
      return await r.text();
    }catch(_){ return ''; } // file:// u otros bloqueos
  }

  function csvToRows(txt){
    const sep = txt.includes(';') ? ';' : ',';
    const lines = txt.replace(/\r/g,'').split('\n').filter(l=>l.trim().length);
    const out = [];
    for (const line of lines){
      const row = [];
      let cur='', inQ=false;
      for (let i=0;i<line.length;i++){
        const c = line[i];
        if (c === '"'){ inQ = !inQ; continue; }
        if (c === sep && !inQ){ row.push(cur); cur=''; continue; }
        cur += c;
      }
      row.push(cur);
      out.push(row.map(v=>v.trim()));
    }
    return out;
  }

  function csvToFullData(turnosCsv, ausCsv){
    const rows = csvToRows(turnosCsv);
    const hdr = rows.shift().map(h=>h.toLowerCase());
    const ci = {
      hotel: hdr.findIndex(h=>/hotel/.test(h)),
      empleado: hdr.findIndex(h=>/emplead/.test(h)),
      fecha: hdr.findIndex(h=>/fecha/.test(h)),
      turno: hdr.findIndex(h=>/turno/.test(h))
    };
    const map = new Map();
    for (const r of rows){
      if (!r.length) continue;
      const hotel = (r[ci.hotel]||'Hotel').trim();
      const f = new Date(r[ci.fecha]);
      if (isNaN(f)) continue;
      const lunes = new Date(f); const wd = (lunes.getDay()+6)%7; lunes.setDate(lunes.getDate()-wd);
      const lunesISO = lunes.toISOString().slice(0,10);
      const k = hotel+'|'+lunesISO;
      if (!map.has(k)) map.set(k,{hotel, semana_lunes:lunesISO, orden_empleados:new Set(), turnos:[]});
      const pack = map.get(k);
      const empleado = (r[ci.empleado]||'').trim();
      const turno = (r[ci.turno]||'').trim();
      pack.orden_empleados.add(empleado);
      pack.turnos.push({empleado, fecha:f.toISOString().slice(0,10), turno});
    }
    const schedule = Array.from(map.values()).map(p=>({
      hotel:p.hotel, semana_lunes:p.semana_lunes,
      orden_empleados:Array.from(p.orden_empleados),
      turnos:p.turnos
    }));
    return { schedule };
  }

  // --- Render
  function defaultMonday(){
    const d = new Date(); const wd = (d.getDay()+6)%7; d.setDate(d.getDate()-wd);
    return d.toISOString().slice(0,10);
  }
  function rangoSemana(lunesISO){
    const d0 = new Date(lunesISO); const d6 = new Date(lunesISO); d6.setDate(d6.getDate()+6);
    const f0 = d0.toLocaleDateString('es-ES',{day:'2-digit',month:'short',year:'2-digit'});
    const f6 = d6.toLocaleDateString('es-ES',{day:'2-digit',month:'short',year:'2-digit'});
    return `${f0} ‚Üí ${f6}`;
  }

  function normalizaTurno(s=''){
    s = s.normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
    if (/vacacion|vac/i.test(s)) return 'vacaciones';
    if (/descanso|libre|d\b/.test(s)) return 'descanso';
    if (/noche|^n\b/.test(s)) return 'noche';
    if (/tarde|^t\b/.test(s)) return 'tarde';
    if (/manana|^m\b/.test(s)) return 'ma√±ana';
    return s;
  }
  function pillHTML(t){
    const val = normalizaTurno(t);
    const map = {
      'ma√±ana':  { cls:'pill--manana', txt:'Ma√±ana', icon:'' },
      'tarde':   { cls:'pill--tarde',  txt:'Tarde',  icon:'üõà' },
      'noche':   { cls:'pill--noche',  txt:'Noche',  icon:'üåô' },
      'descanso':{ cls:'pill--descanso', txt:'Descanso', icon:'' },
      'vacaciones':{ cls:'pill--vacaciones', txt:'Vacaciones', icon:'üèñÔ∏è' }
    };
    const m = map[val] || {cls:'', txt:t, icon:''};
    return `<span class="pill ${m.cls}">${m.icon?`<span class="i">${m.icon}</span>`:''}<span>${m.txt}</span></span>`;
  }

  function populateHotelSelect(){
    const sel = $('#hotelSelect');
    const names = Array.from(new Set(DATA.schedule.map(s=>s.hotel)));
    sel.innerHTML = names.map(n=>`<option value="${n}">${n}</option>`).join('');
  }
  function syncSemana(){
    const inp = $('#semanaInput');
    if (!inp.value) inp.value = defaultMonday();
  }

  function render(){
    const tabla = $('#tablaTurnos');
    const semana = $('#semanaInput').value || defaultMonday();
    const hotel = $('#hotelSelect').value || (DATA.schedule[0]?.hotel || 'Hotel');

    const pack = DATA.schedule.find(s => s.hotel===hotel && s.semana_lunes===semana);
    $('#hotelNombre').textContent = hotel;
    $('#rangoFechas').textContent = rangoSemana(semana);

    if (!pack){
      tabla.innerHTML = `<div class="t-empty">Sin datos para ${hotel} ‚Äî ${fmt(semana)}</div>`;
      return;
    }
    const dias = new Array(7).fill(0).map((_,i)=>{
      const d = new Date(semana); d.setDate(d.getDate()+i);
      return { iso: d.toISOString().slice(0,10),
               label: d.toLocaleDateString('es-ES',{weekday:'short'}),
               fecha: d.toLocaleDateString('es-ES',{day:'2-digit',month:'short',year:'2-digit'}) };
    });
    const byEmpDate = new Map();
    for (const t of pack.turnos){
      const k = t.empleado+'|'+t.fecha;
      if (!byEmpDate.has(k)) byEmpDate.set(k, []);
      byEmpDate.get(k).push(t.turno);
    }
    const visibles = pack.orden_empleados.filter(emp => dias.some(d => byEmpDate.has(emp+'|'+d.iso)));

    let html = `<div class="t-head"><div class="cell"></div>${
      dias.map(d=>`<div class="cell"><div>${capitalize(d.label)}</div><div>${d.fecha}</div></div>`).join('')
    }</div>`;

    for (const emp of visibles){
      html += `<div class="t-row">
        <div class="cell name"><div class="emp">${emp}</div></div>
        ${
          dias.map(d=>{
            const turns = byEmpDate.get(emp+'|'+d.iso) || [];
            return `<div class="cell"><div class="shifts">${turns.map(pillHTML).join('')}</div></div>`;
          }).join('')
        }
      </div>`;
    }
    tabla.innerHTML = html;
  }

  window.addEventListener('load', async ()=>{
    await initData();
    populateHotelSelect();
    syncSemana();
    render();

    $('#refrescarBtn').addEventListener('click', render);
    $('#hotelSelect').addEventListener('change', render);
    $('#semanaInput').addEventListener('change', render);
  });
})();
</script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuadrantes de turnos</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --pill-bg:#eef2ff; --pill-text:#111827; --border:#e5e7eb;
      --m:#d1fae5; --t:#fef3c7; --n:#e0e7ff; --d:#fee2e2; --brand:#0f4c75;
    }
    body{background:var(--bg); font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); margin:0; padding:24px;}
    .container{max-width:1200px;margin:0 auto;}
    header.app{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-radius:14px;background:var(--brand);color:#fff;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
    header .left{display:flex;gap:12px;align-items:center}
    header img.logo{width:36px;height:36px;border-radius:8px;background:#fff;object-fit:cover}
    header .title{font-size:18px;font-weight:700}
    header .meta{opacity:.9;font-size:13px}
    header .right{display:flex;gap:10px;align-items:center}
    header .btn{background:#fff;color:var(--brand);padding:8px 12px;border:none;border-radius:10px;font-weight:700;cursor:pointer}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,.05);}
    table{width:100%; border-collapse:separate; border-spacing:0;}
    th,td{padding:14px 16px; border-bottom:1px solid var(--border); vertical-align:middle;}
    th{background:#0f4c75; color:#fff; font-weight:600; text-align:left;}
    th.center, td.center{text-align:center;}
    tr:last-child td{border-bottom:none;}
    .pill{display:inline-block; min-width:96px; text-align:center; padding:8px 14px; border-radius:999px; font-weight:600; border:1px solid var(--border);}
    .pill.m{background:var(--m);} .pill.t{background:var(--t);} .pill.n{background:var(--n);} .pill.d{background:var(--d);}
    .pill.abs{ color:#fff; border-color:transparent; }
  </style>
</head>
<body>
<div class="container">
  <header class="app">
    <div class="left">
      <img class="logo" src="https://raw.githubusercontent.com/Nataliogc/turnosweb/main/logo.png" onerror="this.style.display='none'">
      <div>
        <div class="title" id="hotelTitle">Cuadrantes</div>
        <div class="meta" id="meta">Semana</div>
      </div>
    </div>
    <div class="right">
      <div class="meta">Actualizado: <span id="lastUpdate"></span></div>
      <button class="btn" id="btnRefresh">Refrescar</button>
    </div>
  </header>

  <div class="card">
    <table id="grid">
      <thead>
        <tr>
          <th>Empleado</th>
          <th class="center">Lunes<br><small id="d0"></small></th>
          <th class="center">Martes<br><small id="d1"></small></th>
          <th class="center">Mi√©rcoles<br><small id="d2"></small></th>
          <th class="center">Jueves<br><small id="d3"></small></th>
          <th class="center">Viernes<br><small id="d4"></small></th>
          <th class="center">S√°bado<br><small id="d5"></small></th>
          <th class="center">Domingo<br><small id="d6"></small></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
// DATA ser√° reemplazado por el generador
const DATA = __DATA_PLACEHOLDER__;

// -------- Helpers
const fmt = (d)=> new Date(d).toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit'});
const startOfWeekMon = (d)=>{ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x;}
const weekStartISO = (isoDate)=>{ const d=new Date(isoDate); d.setHours(0,0,0,0); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); return d.toISOString().slice(0,10); };

const today = new Date();
const week0 = startOfWeekMon(today);
const weekISO = week0.toISOString().slice(0,10);

document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
document.getElementById('btnRefresh').onclick = ()=>location.reload();

// Filtrar por semana desde Fecha (no por texto ‚ÄúSemana‚Äù)
const rowsWeek = DATA.rows.filter(r => weekStartISO(r.Fecha) === weekISO);
const fallbackRows = rowsWeek.length ? rowsWeek : DATA.rows;

// Hotel con m√°s filas en esa semana
const counts = {};
for(const r of fallbackRows){ counts[r.Hotel] = (counts[r.Hotel]||0)+1; }
const hotel = Object.keys(counts).sort((a,b)=>counts[b]-counts[a])[0] || (DATA.rows[0] && DATA.rows[0].Hotel) || 'Hotel';

document.getElementById('hotelTitle').textContent = hotel;
document.getElementById('meta').textContent = `Semana ${fmt(week0)} a ${fmt(new Date(+week0+6*86400000))}`;

// Cabecera fechas
for(let i=0;i<7;i++){
  const d = new Date(+week0+i*86400000);
  document.getElementById('d'+i).textContent = fmt(d);
}

// Filas definitivas de esa semana + hotel
const rows = DATA.rows.filter(r => weekStartISO(r.Fecha) === weekISO && r.Hotel === hotel);

// -------- Agrupar por empleado
const empMap = {};
for(const r of rows){
  if(!empMap[r.Empleado]) empMap[r.Empleado] = { cells:Array(7).fill(null), vac:false, order: (r.OrderSemana ?? 9999) };
  const idx = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"].indexOf(r.Dia);
  if(idx<0) continue;

  // ¬øEs ausencia? -> por VacSemana, por Turno="VAC", por Tipo=Ausente, por patr√≥n de texto o por NameColorC
  const lower = ((r.TextoDia||"") + " " + (r.TurnoLargo||"")).toLowerCase();
  const isAbs = Number(r.VacSemana||0) > 0 ||
                (r.Turno && r.Turno.toUpperCase()==='VAC') ||
                (r.TipoEmpleado && r.TipoEmpleado.toLowerCase()==='ausente') ||
                /(vaca|baja|permiso|formaci|libr|ausen|it)/.test(lower) ||
                !!(r.NameColorC && r.NameColorC.length>0);

  if(isAbs) empMap[r.Empleado].vac = true;

  // Resolver duplicados: preferimos la ausencia; si no, el de menor OrderDia
  const cur = empMap[r.Empleado].cells[idx];
  const score = (x)=> x ? ((Number(x.VacSemana||0)>0 || (x.Turno||'').toUpperCase()==='VAC')? 1000 : 0) - (x.OrderDia ?? 0) : -9999;
  if(!cur || score(r) > score(cur)) {
    empMap[r.Empleado].cells[idx] = Object.assign({}, r, { isAbs });
  }
}

// Orden final: por OrderSemana y vacaciones al final
const empleados = Object.entries(empMap)
  .sort((A,B)=>{
    const a=A[1], b=B[1];
    if(a.vac!==b.vac) return a.vac ? 1 : -1;
    if(a.order!==b.order) return (a.order??9999) - (b.order??9999);
    return A[0].localeCompare(B[0],'es');
  });

// -------- Pintar
const pill = (r)=>{
  if(!r) return '';
  if(r.isAbs){
    const bg = r.NameColorC || '#FF4C4C';
    const txt = r.TextoDia?.trim() || r.TurnoLargo || 'Ausencia';
    return `<span class="pill abs" style="background:${bg}">${r.Icono||'üèñÔ∏è'} ${txt}</span>`;
  }
  const map = {M:'m',T:'t',N:'n',D:'d'};
  const k = r.Turno ? r.Turno.toUpperCase() : '';
  const cls = map[k] || '';
  const label = r.TurnoLargo || r.TextoDia || r.Turno || '';
  return label ? `<span class="pill ${cls}">${label}</span>` : '';
};

const tb = document.getElementById('tbody');
for(const [emp,info] of empleados){
  const tr = document.createElement('tr');
  const tdName = document.createElement('td');
  tdName.textContent = emp;
  tr.appendChild(tdName);
  for(let i=0;i<7;i++){
    const td = document.createElement('td');
    td.className = 'center';
    td.innerHTML = pill(info.cells[i]);
    tr.appendChild(td);
  }
  tb.appendChild(tr);
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cuadrantes de turnos</title>
<style>
  :root{ --bg:#f6fafb; --ink:#1c2834; --muted:#3c556e; --card:#fff; --br:#e7edf3; --sh:0 4px 16px rgba(0,0,0,.05); --brand:#0a6aa1; }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1180px;margin:20px auto 90px;padding:0 14px}
  .card, .bar, .panel, header.app{background:var(--card);border:1px solid var(--br);border-radius:14px;box-shadow:var(--sh)}
  header.app{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:12px 16px;margin-bottom:12px;background:var(--brand);color:#fff}
  header.app h1{margin:0;font-size:1.35rem}
  .bar{padding:12px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
  .btn{border:1px solid #cfe0ec;background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  input[type="text"],select,input[type="date"]{padding:10px 12px;border:1px solid #d6e3ef;border-radius:10px;min-width:180px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{border-bottom:1px solid #eef3f8;padding:8px 8px;text-align:center;vertical-align:middle}
  th{text-align:left;background:#f3f7fb;color:var(--muted);position:sticky;top:0;z-index:1}
  .card{border-radius:14px;overflow:hidden;margin-bottom:16px}
  .card header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#f9fbff;border-bottom:1px solid var(--br)}
  .namecol{width:260px;text-align:left}
  .name-with-dot{display:flex;flex-direction:column;gap:2px}
  .name-with-dot .row{display:flex;align-items:center;gap:6px}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle;background:#cad6e4}
  .pill-shift{min-width:90px;height:30px;display:inline-flex;align-items:center;justify-content:center;border:1px solid #e6eef6;border-radius:999px;font-weight:600;font-size:.9rem;padding:0 10px;white-space:nowrap;gap:6px}
  .ps-m{background:#e9f7ef;border-color:#cbe8d1}.ps-t{background:#fff8df;border-color:#efe6b2}.ps-n{background:#eef2ff;border-color:#cbd7ff}.ps-d{background:#ffeaea;border-color:#ffd0d0}.ps-empty{background:#fff}
  .is-abs{font-weight:700}.abs{background:rgba(128,128,128,0.12);border-color:#aaa;color:#444}
  .legend{font-size:.85rem;color:#5b6a7c;padding:8px 12px}
  .th-day{display:flex;flex-direction:column;align-items:center}.th-day small{color:#7b8da3;font-weight:500;margin-top:2px}
  .error{background:#ffecec;color:#a40000;border:1px solid #f5b5b5;padding:10px 12px;border-radius:10px;margin:12px 0}
</style>
</head>
<body>
<div class="wrap">
  <header class="app">
    <div style="display:flex;align-items:center;gap:12px;"><h1 style="margin:0;">Cuadrantes de turnos</h1></div>
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;"><span>Actualizado: <b id="lastUpdate">—</b></span><button class="btn primary noprint" id="btnRefresh">Refrescar</button></div>
  </header>

  <div id="errors" class="error" style="display:none"></div>

  <div class="bar noprint">
    <div class="row">
      <div><label>Buscar</label><br/><input id="q" type="text" placeholder="Empleado u hotel" /></div>
      <div><label>Hotel</label><br/><select id="hotel"><option value="__ALL__">— Todos —</option></select></div>
      <div><label>Desde</label><br/><input id="desde" type="date" /></div>
      <div><label>Hasta</label><br/><input id="hasta" type="date" /></div>
      <div><label>Empleado</label><br/><select id="empleado"><option value="">— Selecciona —</option></select></div>
      <div><label>&nbsp;</label><br/><button id="btnIcs" class="btn">Descargar .ics</button></div>
      <div><label>&nbsp;</label><br/><button id="btnClear" class="btn">Limpiar</button></div>
    </div>
  </div>

  <div id="root"></div>
  <div class="legend">Leyenda: <span class="pill-shift ps-m">Mañana</span> · <span class="pill-shift ps-t">Tarde</span> · <span class="pill-shift ps-n">Noches</span> · <span class="pill-shift ps-d">Descanso</span> · <span class="pill-shift abs">Ausencias (Vacaciones/Baja/…)</span></div>
</div>

<script>
try {
  const DATA = __DATA_PLACEHOLDER__;
  const errors = document.getElementById('errors');
  const showError = (msg) => { errors.textContent = msg; errors.style.display='block'; console.error(msg); };

  const lastUpdateEl = document.getElementById('lastUpdate');
  lastUpdateEl.textContent = new Date().toLocaleString();
  document.getElementById('btnRefresh').onclick = ()=>location.reload();

  const rowsAll = (DATA && DATA.rows) ? DATA.rows : [];
  if (!rowsAll.length) showError("No hay datos para mostrar. Comprueba las fechas en el Excel.");

  const days = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];
  const fmtEsFull = (s) => { const d = new Date(s+'T00:00:00'); return String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + d.getFullYear(); };
  const classFromLong = (longTxt) => {
    const t = (longTxt||"").toLowerCase();
    if (t.startsWith("mañ") || t.startsWith("man")) return "ps-m";
    if (t.startsWith("tar")) return "ps-t";
    if (t.startsWith("noch")) return "ps-n";
    if (t.startsWith("desc")) return "ps-d";
    return "ps-empty";
  };
  const isNight = (r) => {
    const t = (r.TextoDia||r.TurnoLargo||r.Turno||"").toLowerCase();
    return t.includes("noch") || r.Turno==="N";
  };
  const parseYMD = s => { const [y,m,d] = (s||"").split('-').map(n=>parseInt(n,10)); return new Date(y, (m||1)-1, d||1); };
  const ymd = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  const dayIdx = s => { const x = parseYMD(s); return (x.getDay()+6)%7; };
  const weekStartStr = s => { const x = parseYMD(s); const w = (x.getDay()+6)%7; x.setDate(x.getDate()-w); return ymd(x); };
  const weekEndStr = s => { const x = parseYMD(s); const w = (x.getDay()+6)%7; x.setDate(x.getDate()+(6-w)); return ymd(x); };

  // Populate hotel select
  const hotelSel = document.getElementById('hotel');
  const hotels = Array.from(new Set(rowsAll.map(r=>r.Hotel).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'es'));
  hotels.forEach(h=>{ const o=document.createElement('option'); o.value=h; o.textContent=h; hotelSel.appendChild(o);});

  // Date defaults (sin límite)
  const desdeEl = document.getElementById('desde');
  const hastaEl = document.getElementById('hasta');
  const fmt = x => x.toISOString().slice(0,10);
  const today = new Date(); const d30 = new Date(today); d30.setDate(d30.getDate()+30);
  desdeEl.value = fmt(today); hastaEl.value = fmt(d30);

  let LAST_ROWS = [];
  const state = { q:"", hotel:"__ALL__", desde:desdeEl.value, hasta:hastaEl.value };
  function fillEmployees(rows){
    const todayStr = new Date().toISOString().slice(0,10);
    const minDate = state.desde ? (state.desde > todayStr ? state.desde : todayStr) : todayStr;
    let r = rows.filter(x => (!state.hotel || state.hotel==="__ALL__" || x.Hotel===state.hotel));
    r = r.filter(x => x.Fecha >= minDate);
    const emps = Array.from(new Set(r.map(x=>x.Empleado).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'es'));
    const empleadoSel = document.getElementById('empleado');
    empleadoSel.innerHTML = '<option value="">— Selecciona —</option>' + emps.map(e=>`<option value="{e}">{e}</option>`.replaceAll('{e}', e)).join('');
  }

  const applyFilters = () => {
    let rows = rowsAll.slice();
    if (state.q){
      const q = state.q.toLowerCase();
      rows = rows.filter(r => (r.Empleado||"").toLowerCase().includes(q) || (r.Hotel||"").toLowerCase().includes(q));
    }
    if (state.hotel && state.hotel!=="__ALL__"){
      rows = rows.filter(r => r.Hotel===state.hotel);
    }
    if (state.desde){ rows = rows.filter(r => r.Fecha >= state.desde); }
    if (state.hasta){ rows = rows.filter(r => r.Fecha <= state.hasta); }
    LAST_ROWS = rows.slice();
    fillEmployees(rows);
    render(rows);
  };

  // Bind controls
  document.getElementById('q').addEventListener('input', e=>{state.q=e.target.value; applyFilters();});
  hotelSel.addEventListener('change', e=>{state.hotel=e.target.value; applyFilters();});
  desdeEl.addEventListener('change', e=>{state.desde=e.target.value; applyFilters();});
  hastaEl.addEventListener('change', e=>{state.hasta=e.target.value; applyFilters();});
  document.getElementById('btnClear').addEventListener('click', ()=>{
    state.q=""; state.hotel="__ALL__";
    const t=new Date(); const m=new Date(t); m.setDate(m.getDate()+30);
    desdeEl.value = fmt(t); hastaEl.value = fmt(m);
    state.desde=desdeEl.value; state.hasta=hastaEl.value;
    document.getElementById('q').value="";
    hotelSel.value="__ALL__";
    document.getElementById('empleado').value="";
    applyFilters();
  });

  // ICS export EXACT TEXT (TextoDia). Excluir días vacíos.
  document.getElementById('btnIcs').addEventListener('click', ()=>{
    const empleadoSel = document.getElementById('empleado');
    const emp = empleadoSel.value;
    if(!emp){ alert("Selecciona un empleado."); return; }
    const start = state.desde;
    const end   = state.hasta;

    let base = Array.isArray(LAST_ROWS) && LAST_ROWS.length ? LAST_ROWS : (DATA.rows || []);
    let rows = base.filter(r => r.Empleado===emp && r.Fecha>=start && r.Fecha<=end);
    if(!rows.length){ rows = (DATA.rows||[]).filter(r=>r.Empleado===emp && r.Fecha>=start && r.Fecha<=end); }
    rows = rows.map(r => {
      const text = (r.TextoDia || r.TurnoLargo || r.Turno || "").toString().trim();
      return { ...r, _text: text };
    }).filter(r => r._text !== "");

    if(!rows.length){ alert("No hay datos para ese periodo."); return; }

    const lines = [];
    lines.push("BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//TurnosWeb//ES");
    rows.forEach((r,i)=>{
      const title = r._text.replace(/\\r?\\n/g,' ');
      const dt = r.Fecha.replace(/-/g,"");
      lines.push("BEGIN:VEVENT");
      lines.push("UID:TW-"+dt+"-"+i+"@turnosweb");
      lines.push("DTSTAMP:"+dt+"T000000Z");
      lines.push("DTSTART;VALUE=DATE:"+dt);
      lines.push("SUMMARY:"+title);
      if (r.Hotel) lines.push("LOCATION:"+r.Hotel);
      lines.push("STATUS:CONFIRMED");
      lines.push("END:VEVENT");
    });
    lines.push("END:VCALENDAR");
    const blob = new Blob([lines.join("\\r\\n")], {type:"text/calendar;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `turnos_${emp.replace(/\\s+/g,'_')}_${start}_a_${end}.ics`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  });

  function render(rows) {
    const root = document.getElementById('root');
    root.innerHTML = "";

    if(!rows || rows.length===0){
      root.innerHTML = '<div class="panel" style="padding:12px;">No hay resultados con los filtros aplicados.</div>';
      return;
    }

    // Group by hotel + week
    const groups = new Map();
    rows.forEach(r => {
      if(!r.Fecha || !r.Hotel || !r.Empleado) return;
      const k = r.Hotel + "|" + weekStartStr(r.Fecha);
      if(!groups.has(k)){
        groups.set(k, {hotel:r.Hotel, wstart: weekStartStr(r.Fecha), wend: weekEndStr(r.Fecha), rows:new Map()});
      }
      const g = groups.get(k);

      if(!g.rows.has(r.Empleado)){
        g.rows.set(r.Empleado, {name:r.Empleado, order:r.OrderSemana ?? r.EmpleadoOrdenSemanaBase ?? r.OrderBaseHotel ?? 0, vac:false, cells:new Array(7).fill(null)});
      }
      const mainRow = g.rows.get(r.Empleado);
      const idx = dayIdx(r.Fecha);
      const lower = (r.TextoDia||"").toLowerCase();
      if ( lower.includes("vaca") ){
        mainRow.vac = true;
      }

      if ( lower.includes("vaca") || r.TipoEmpleado==="Ausente" ){
        const text = r.TextoDia || "Ausencia";
        mainRow.cells[idx] = {kind:"abs", long:text};
      } else {
        const text = r.TextoDia || r.TurnoLargo || r.Turno || "";
        mainRow.cells[idx] = {kind:"shift", long:text, icon:r.Icono||""};
      }
    });

    const ordered = Array.from(groups.values()).sort((a,b)=> (a.wstart<b.wstart?-1: a.wstart>b.wstart?1: a.hotel.localeCompare(b.hotel)) );

    // Render groups gradually
    const rootEl = document.getElementById('root');
    let gi = 0;
    function renderNextGroup(){
      if (gi >= ordered.length) return;
      const g = ordered[gi++];
      let entries = Array.from(g.rows.values());
      entries.sort((a,b) => {
        if (a.vac !== b.vac) return a.vac ? 1 : -1; // Vacaciones al final
        if (a.order !== b.order) return (a.order||0) - (b.order||0);
        return a.name.localeCompare(b.name,'es');
      });

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<header>
          <div><b>${g.hotel}</b> — Semana ${fmtEsFull(g.wstart)} a ${fmtEsFull(g.wend)}</div>
          <div style="font-size:.9rem;color:#6a7b8e">${entries.length} empleados / ${days.length} días</div>
        </header>`;

      const table = document.createElement('table');
      const startDate = parseYMD(g.wstart);
      let thDays = '<thead><tr><th class="namecol">Empleado</th>';
      for (let i=0;i<7;i++){
        const d = new Date(startDate); d.setDate(startDate.getDate()+i);
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        thDays += `<th><div class="th-day"><span>${days[i]}</span><small>${dd}/${mm}</small></div></th>`;
      }
      thDays += '</tr></thead>';
      table.innerHTML = thDays;

      const tbody = document.createElement('tbody');
      const cellHTML = c => {
        if(!c) return '<div class="pill-shift ps-empty">&nbsp;</div>';
        if(c.kind==="abs"){
          return `<div class="pill-shift is-abs abs" title="${c.long||""}">${c.long||"&nbsp;"}</div>`;
        }
        const cls = classFromLong(c.long);
        const icon = c.icon ? (c.icon + "&nbsp;") : "";
        return `<div class="pill-shift ${cls}" title="${c.long||""}">${icon}${c.long||"&nbsp;"}</div>`;
      };

      entries.forEach(row => {
        const nameCell = `<div class="name-with-dot"><div class="row"><span class="dot"></span><b>${row.name}</b></div></div>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="namecol">${nameCell}</td>${row.cells.map(c=>`<td>${cellHTML(c)}</td>`).join('')}`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      // Month-end nights summary
      function isMonthEnd(dateStr){ const d = parseYMD(dateStr); const next = new Date(d); next.setDate(d.getDate()+1); return next.getMonth() !== d.getMonth(); }
      card.appendChild(table);
      if (isMonthEnd(g.wend)){
        const m0 = parseYMD(g.wend); const ym = `${m0.getFullYear()}-${String(m0.getMonth()+1).padStart(2,'0')}`;
        const hotelRows = rows.filter(rr => rr.Hotel===g.hotel && rr.Fecha.startsWith(ym));
        const counts = new Map();
        hotelRows.forEach(r => { if (isNight(r)) counts.set(r.Empleado, (counts.get(r.Empleado)||0)+1); });
        const items = Array.from(counts.entries()).filter(([name, n])=>n>0).sort((a,b)=>b[1]-a[1] || a[0].localeCompare(b[0],'es'));
        const footer = document.createElement('div');
        let htmlFooter = `<div style="padding:10px 12px;border-top:1px solid #e7edf3;background:#fbfdff;"><b>Resumen Noches ${String(m0.getMonth()+1).padStart(2,'0')}/${m0.getFullYear()}</b>`;
        htmlFooter += '<div style="overflow:auto;"><table style="width:100%;border-collapse:separate;border-spacing:0;margin-top:6px"><thead><tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #eef3f8">Empleado</th><th style="padding:6px 8px;border-bottom:1px solid #eef3f8;text-align:center">Noches</th></tr></thead><tbody>';
        items.forEach(([name,n])=>{ htmlFooter += `<tr><td style="text-align:left;padding:6px 8px;border-bottom:1px solid #f1f5f9">${name}</td><td style="padding:6px 8px;border-bottom:1px solid #f1f5f9;text-align:center">${n}</td></tr>`; });
        if (!items.length){ htmlFooter += `<tr><td colspan="2" style="text-align:center;padding:10px 8px;color:#7a8ca2">Sin noches este mes</td></tr>`; }
        htmlFooter += '</tbody></table></div></div>';
        footer.innerHTML = htmlFooter;
        card.appendChild(footer);
      }

      rootEl.appendChild(card);
      requestAnimationFrame(renderNextGroup);
    }
    requestAnimationFrame(renderNextGroup);
  }

  // First render
  applyFilters();

  window.addEventListener('error', (e)=>showError('Error JS: '+e.message));
} catch (e) {
  const errors = document.getElementById('errors');
  errors.textContent = 'Error de inicio: ' + (e && e.message ? e.message : e);
  errors.style.display='block';
}
</script>
</body>
</html>
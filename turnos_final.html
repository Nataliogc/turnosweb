<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuadrantes de turnos</title>
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --pill-bg:#eef2ff; --pill-text:#111827; --border:#e5e7eb;
      --m:#d1fae5; --t:#fef3c7; --n:#e0e7ff; --d:#fee2e2;
    }
    body{background:var(--bg); font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); margin:0; padding:24px;}
    .container{max-width:1200px;margin:0 auto;}
    h1{margin:0 0 18px 0; font-size:24px;}
    .meta{color:var(--muted); margin-bottom:16px;}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,.05);}
    table{width:100%; border-collapse:separate; border-spacing:0;}
    th,td{padding:14px 16px; border-bottom:1px solid var(--border); vertical-align:middle;}
    th{background:#0f4c75; color:#fff; font-weight:600; text-align:left;}
    th.center, td.center{text-align:center;}
    tr:last-child td{border-bottom:none;}
    .pill{display:inline-block; min-width:96px; text-align:center; padding:8px 14px; border-radius:999px; font-weight:600; border:1px solid var(--border);}
    .pill.m{background:var(--m);} .pill.t{background:var(--t);} .pill.n{background:var(--n);} .pill.d{background:var(--d);}
    .pill.abs{ color:#fff; border-color:transparent; }
  </style>
</head>
<body>
<div class="container">
  <h1 id="hotelTitle">Cuadrantes</h1>
  <div class="meta" id="meta"></div>
  <div class="card">
    <table id="grid">
      <thead>
        <tr>
          <th>Empleado</th>
          <th class="center">Lunes<br><small id="d0"></small></th>
          <th class="center">Martes<br><small id="d1"></small></th>
          <th class="center">Mi√©rcoles<br><small id="d2"></small></th>
          <th class="center">Jueves<br><small id="d3"></small></th>
          <th class="center">Viernes<br><small id="d4"></small></th>
          <th class="center">S√°bado<br><small id="d5"></small></th>
          <th class="center">Domingo<br><small id="d6"></small></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
const DATA = __DATA_PLACEHOLDER__;

// Helpers
const fmt = (d)=> new Date(d).toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit'});
const startOfWeekMon = (d)=>{ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x;}
const weekStartISO = (isoDate)=>{ const d=new Date(isoDate); d.setHours(0,0,0,0); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); return d.toISOString().slice(0,10); };

const today = new Date();
const week0 = startOfWeekMon(today);
const weekISO = week0.toISOString().slice(0,10);

// Filtra filas de esa semana calculada desde "Fecha"
const rowsWeek = DATA.rows.filter(r => weekStartISO(r.Fecha) === weekISO);

// Si no hay filas (por cach√© o rango), cae a la primera semana disponible
const fallbackRows = rowsWeek.length ? rowsWeek : DATA.rows;

// Hotel con m√°s filas en esa semana (o primero si empate)
const counts = {};
for(const r of fallbackRows){ counts[r.Hotel] = (counts[r.Hotel]||0)+1; }
const hotel = Object.keys(counts).sort((a,b)=>counts[b]-counts[a])[0] || (DATA.rows[0] && DATA.rows[0].Hotel) || 'Hotel';

document.getElementById('hotelTitle').textContent = hotel;
document.getElementById('meta').textContent = `Semana ${fmt(week0)} a ${fmt(new Date(+week0+6*86400000))}`;

for(let i=0;i<7;i++){
  const d = new Date(+week0+i*86400000);
  document.getElementById('d'+i).textContent = fmt(d);
}

// Selecci√≥n final de filas: misma semana por Fecha y ese hotel
const rows = DATA.rows.filter(r => weekStartISO(r.Fecha) === weekISO && r.Hotel === hotel);

// Agrupa por empleado
const empMap = {};
for(const r of rows){
  if(!empMap[r.Empleado]) empMap[r.Empleado] = Array(7).fill(null);
  const idx = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"].indexOf(r.Dia);
  if(idx>=0) {
    // Mantenemos la mejor fila si hubiera duplicados (por sustituciones)
    const cur = empMap[r.Empleado][idx];
    if(!cur || (cur.VacSemana||0) < (r.VacSemana||0) || (cur.OrderDia||9999) > (r.OrderDia||9999)){
      empMap[r.Empleado][idx] = r;
    }
  }
}
const empleados = Object.keys(empMap).sort((a,b)=>{
  const oA = rows.find(x=>x.Empleado===a)?.OrderSemana ?? 9999;
  const oB = rows.find(x=>x.Empleado===b)?.OrderSemana ?? 9999;
  if(oA!==oB) return oA-oB;
  return a.localeCompare(b,'es');
});

const pill = (r)=>{
  if(!r) return '';
  // Ausencias (vacaciones/baja/permiso, etc) detectadas por NameColorC o Turno == 'VAC'
  if((r.NameColorC && r.NameColorC.length>0) || (r.Turno && r.Turno.toUpperCase()==='VAC')){
    const bg = r.NameColorC || '#FF4C4C';
    const txt = r.TextoDia && r.TextoDia.trim() ? r.TextoDia : (r.TurnoLargo||'Ausencia');
    return `<span class="pill abs" style="background:${bg}">${r.Icono||'üèñÔ∏è'} ${txt}</span>`;
  }
  // Turnos est√°ndar
  const map = {M:'m',T:'t',N:'n',D:'d'};
  const k = r.Turno ? r.Turno.toUpperCase() : '';
  const cls = map[k] || '';
  const label = r.TurnoLargo || r.TextoDia || '';
  return label ? `<span class="pill ${cls}">${label}</span>` : '';
};

const tb = document.getElementById('tbody');
for(const emp of empleados){
  const tr = document.createElement('tr');
  const tdName = document.createElement('td');
  tdName.textContent = emp;
  tr.appendChild(tdName);
  for(let i=0;i<7;i++){
    const td = document.createElement('td');
    td.className = 'center';
    td.innerHTML = pill(empMap[emp][i]);
    tr.appendChild(td);
  }
  tb.appendChild(tr);
}
</script>
</body>
</html>
